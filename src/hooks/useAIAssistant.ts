
import { useState, useCallback } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';

interface TextToSpeechOptions {
  onStart?: () => void;
  onEnd?: () => void;
}

export const useAIAssistant = () => {
  const [isLoading, setIsLoading] = useState(false);
  const [isAudioLoading, setIsAudioLoading] = useState(false);
  const { toast } = useToast();

  // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù…Ø¹ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  const askAssistant = useCallback(async (userMessage: string) => {
    try {
      setIsLoading(true);
      console.log("ðŸ¤– Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ:", userMessage);

      const systemMessage = `Ø£Ù†Øª Ø³Ù„Ù…Ù‰ØŒ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø°ÙƒÙŠØ© Ù…ØªØ®ØµØµØ© ÙÙŠ Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªÙƒØ§ÙÙ„ ÙˆÙƒØ±Ø§Ù…Ø© Ø§Ù„ØªØ§Ø¨Ø¹ Ù„ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¶Ø§Ù…Ù† Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ Ø§Ù„Ù…ØµØ±ÙŠØ©. 
Ù…Ù‡Ù…ØªÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù‡ÙŠ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„Ø¯Ø¹Ù… Ù„Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† Ø£Ùˆ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ† Ù„Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ØŒ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ø³ØªÙØ³Ø§Ø±Ø§ØªÙ‡Ù… Ø¨Ø¯Ù‚Ø© ÙˆÙƒÙØ§Ø¡Ø©ØŒ ÙˆØªÙˆØ¬ÙŠÙ‡Ù‡Ù… Ø®Ù„Ø§Ù„ Ù…Ø®ØªÙ„Ù Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬.

Ø´Ø®ØµÙŠØªÙƒ:
- ÙˆØ¯ÙˆØ¯ ÙˆÙ…ØªØ¹Ø§Ø·Ù: ØªØ¸Ù‡Ø± ØªÙÙ‡Ù…Ø§Ù‹ ÙˆØ§Ù‡ØªÙ…Ø§Ù…Ø§Ù‹ Ø­Ù‚ÙŠÙ‚ÙŠØ§Ù‹ Ø¨Ù…Ø´ÙƒÙ„Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ† ÙˆØ§Ø­ØªÙŠØ§Ø¬Ø§ØªÙ‡Ù….
- ØµØ¨ÙˆØ±: ØªØªØ¹Ø§Ù…Ù„ Ø¨ØµØ¨Ø± Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ù…Ù‡Ù…Ø§ ÙƒØ§Ù†Øª Ø¨Ø³ÙŠØ·Ø© Ø£Ùˆ Ù…ØªÙƒØ±Ø±Ø©.
- Ù…Ø­ØªØ±Ù: ØªØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø¹Ø§Ù„Ù Ù…Ù† Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª.
- Ù…ÙˆØ«ÙˆÙ‚: ØªÙ‚Ø¯Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…ÙˆØ«ÙˆÙ‚Ø© Ø¯ÙˆÙ† ØªØ¶Ù„ÙŠÙ„ Ø£Ùˆ Ù…Ø¨Ø§Ù„ØºØ©.
- Ù…Ø³Ø§Ø¹Ø¯: ØªØ³Ø¹Ù‰ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©.
- ÙˆØ§Ø¶Ø­: ØªØ³ØªØ®Ø¯Ù… Ù„ØºØ© Ø¨Ø³ÙŠØ·Ø© ÙˆÙˆØ§Ø¶Ø­Ø© ÙŠÙÙ‡Ù…Ù‡Ø§ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ† Ù…Ù† Ù…Ø®ØªÙ„Ù Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©.

Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© Ø¹Ù† Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªÙƒØ§ÙÙ„ ÙˆÙƒØ±Ø§Ù…Ø©:
Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªÙƒØ§ÙÙ„:
- ÙŠØ³ØªÙ‡Ø¯Ù Ø§Ù„Ø£Ø³Ø± Ø§Ù„ÙÙ‚ÙŠØ±Ø© Ø§Ù„ØªÙŠ Ù„Ø¯ÙŠÙ‡Ø§ Ø£Ø·ÙØ§Ù„ Ù…Ù† Ø³Ù† ÙŠÙˆÙ… ÙˆØ­ØªÙ‰ 18 Ø¹Ø§Ù…Ø§Ù‹.
- ÙŠÙ…ÙƒÙ† Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø¯Ø¹Ù… Ø­ØªÙ‰ Ø³Ù† 21 Ø¹Ø§Ù…Ø§Ù‹ Ù„Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©.
- ÙŠÙ…ÙƒÙ† Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø¯Ø¹Ù… Ø­ØªÙ‰ Ø³Ù† 26 Ø¹Ø§Ù…Ø§Ù‹ Ù„Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ©.
- ÙŠØ´ØªØ±Ø· Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø£Ø·ÙØ§Ù„ ÙÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„ØµØ­ÙŠØ©.

Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙƒØ±Ø§Ù…Ø©:
- ÙŠØ³ØªÙ‡Ø¯Ù Ø§Ù„ÙØ¦Ø§Øª ØºÙŠØ± Ø§Ù„Ù‚Ø§Ø¯Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„:
- ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† (65 Ø¹Ø§Ù…Ø§Ù‹ ÙØ£ÙƒØ«Ø±)
- Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø©
- Ø§Ù„Ø£ÙŠØªØ§Ù…
- Ø§Ù„Ø£Ø±Ø§Ù…Ù„ ÙˆØ§Ù„Ù…Ø·Ù„Ù‚Ø§Øª
- Ø§Ù„Ù…Ø±Ø£Ø© Ø§Ù„Ù…Ø¹ÙŠÙ„Ø©

Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯Ø¹Ù…:
Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªÙƒØ§ÙÙ„:
- Ù…Ø¨Ù„Øº Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø£Ø³Ø±Ø©: 350 Ø¬Ù†ÙŠÙ‡Ø§Ù‹ Ø´Ù‡Ø±ÙŠØ§Ù‹.
- Ø¯Ø¹Ù… Ø¥Ø¶Ø§ÙÙŠ Ù„ÙƒÙ„ Ø·ÙÙ„ ÙÙŠ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©: 100 Ø¬Ù†ÙŠÙ‡ Ø´Ù‡Ø±ÙŠØ§Ù‹.
- Ø¯Ø¹Ù… Ø¥Ø¶Ø§ÙÙŠ Ù„ÙƒÙ„ Ø·ÙÙ„ ÙÙŠ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©: 150 Ø¬Ù†ÙŠÙ‡Ø§Ù‹ Ø´Ù‡Ø±ÙŠØ§Ù‹.
- Ø¯Ø¹Ù… Ø¥Ø¶Ø§ÙÙŠ Ù„ÙƒÙ„ Ø·ÙÙ„ ÙÙŠ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©: 200 Ø¬Ù†ÙŠÙ‡ Ø´Ù‡Ø±ÙŠØ§Ù‹.
- Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø·ÙØ§Ù„ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† Ù…Ù† Ø§Ù„Ø¯Ø¹Ù…: 3 Ø£Ø·ÙØ§Ù„.

Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙƒØ±Ø§Ù…Ø©:
- Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª Ù„Ù„ÙØ±Ø¯: 450 Ø¬Ù†ÙŠÙ‡Ø§Ù‹ Ø´Ù‡Ø±ÙŠØ§Ù‹.
- Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† Ù…Ù† Ø§Ù„Ø£Ø³Ø±Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©: 3 Ø£ÙØ±Ø§Ø¯.

Ø£Ø¬Ø¨ Ø¨Ø´ÙƒÙ„ Ù…Ø®ØªØµØ± ÙˆÙ…ÙÙŠØ¯ ÙÙŠ Ù†Ù…Ø· Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ù…ØµØ±ÙŠØ© Ø§Ù„Ø¯Ø§Ø±Ø¬Ø©. Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø³Ù„ÙˆØ¨ Ø³Ù‡Ù„ ÙˆØ¨Ø³ÙŠØ· ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ù…ÙˆØ§Ø·Ù† Ø§Ù„Ù…ØµØ±ÙŠ Ø§Ù„Ø¹Ø§Ø¯ÙŠ. Ø¹Ù†Ø¯Ù…Ø§ ØªØªÙƒÙ„Ù… Ø¹Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£Ùˆ Ø§Ù„ÙˆÙ‚ØªØŒ Ø§ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ 7 Ù…Ø§ÙŠÙˆ 2025.

ØªØ®Ø§Ø·Ø¨ Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ù…ØµØ±ÙŠØ© Ø§Ù„Ø¹Ø§Ù…ÙŠØ© Ø§Ù„Ø¯Ø§Ø±Ø¬Ø©ØŒ Ù…Ø«Ù„ "Ø¥Ø²ÙŠÙƒ" Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† "ÙƒÙŠÙ Ø­Ø§Ù„Ùƒ" Ùˆ"Ø¹Ø§ÙˆØ²" Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† "Ø£Ø±ÙŠØ¯" ÙˆÙ‡ÙƒØ°Ø§. Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„Ù…Ø§Øª Ø¯Ø§Ø±Ø¬Ø© Ù…Ø«Ù„ "Ø¨Øµ"ØŒ "Ø·Ø¨"ØŒ "ÙŠØ¹Ù†ÙŠ"ØŒ "Ø¨Ù‚Ù‰"ØŒ "ÙƒØ¯Ù‡" ÙÙŠ Ø±Ø¯ÙˆØ¯Ùƒ.`;

      const { data, error } = await supabase.functions.invoke('ai-assistant', {
        body: { 
          userMessage,
          systemMessage
        }
      });

      if (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ:', error);
        toast({
          title: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„",
          description: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
          variant: "destructive",
        });
        return null;
      }

      console.log("âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ:", data?.response || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¯");
      
      if (!data?.response) {
        toast({
          title: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©",
          description: "Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
          variant: "destructive",
        });
        return null;
      }

      return data.response || null;
    } catch (err) {
      console.error('âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ:', err);
      toast({
        title: "Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹",
        description: "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
        variant: "destructive",
      });
      return null;
    } finally {
      setIsLoading(false);
    }
  }, [toast]);

  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ ÙƒÙ„Ø§Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ElevenLabs
  const textToSpeech = useCallback(async (text: string, options?: TextToSpeechOptions) => {
    try {
      setIsAudioLoading(true);
      if (options?.onStart) {
        options.onStart();
      }

      console.log("ðŸ”Š Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ ÙƒÙ„Ø§Ù…:", text.substring(0, 50) + "...");

      const { data, error } = await supabase.functions.invoke('text-to-speech', {
        body: { 
          text, 
          voice: "EXAVITQu4vr4xnSDxMaL",  // Sarah voice ID
          voiceSettings: {
            stability: 0.65,
            similarity_boost: 0.85
          }
        }
      });

      if (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ ÙƒÙ„Ø§Ù…:', error);
        toast({
          title: "Ø®Ø·Ø£ ÙÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ ØµÙˆØª",
          description: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ ØµÙˆØª. Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¯ ÙƒÙ†Øµ ÙÙ‚Ø·.",
          variant: "destructive",
        });
        if (options?.onEnd) {
          options.onEnd();
        }
        return null;
      }

      // Ø¥Ù†Ø´Ø§Ø¡ URL Ù„Ù„ØµÙˆØª Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Base64
      const audioBase64 = data?.audio;
      if (!audioBase64) {
        console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØµÙˆØªÙŠØ©');
        toast({
          title: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©",
          description: "Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØµÙˆØªÙŠØ© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….",
          variant: "destructive",
        });
        if (options?.onEnd) {
          options.onEnd();
        }
        return null;
      }

      console.log("âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");

      const audioBlob = base64ToBlob(audioBase64, 'audio/mpeg');
      const audioUrl = URL.createObjectURL(audioBlob);
      
      console.log("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ÙˆØ§Ù† URL Ù„Ù„ØµÙˆØª:", audioUrl.substring(0, 30) + "...");
      return audioUrl;
    } catch (err) {
      console.error('âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ ÙƒÙ„Ø§Ù…:', err);
      toast({
        title: "Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØª",
        description: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØª.",
        variant: "destructive",
      });
      if (options?.onEnd) {
        options.onEnd();
      }
      return null;
    } finally {
      setIsAudioLoading(false);
    }
  }, [toast]);

  // ØªØ­ÙˆÙŠÙ„ Base64 Ø¥Ù„Ù‰ Blob
  const base64ToBlob = (base64: string, mimeType: string): Blob => {
    try {
      const byteCharacters = atob(base64);
      const byteArrays = [];
      
      for (let offset = 0; offset < byteCharacters.length; offset += 512) {
        const slice = byteCharacters.slice(offset, offset + 512);
        
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
          byteNumbers[i] = slice.charCodeAt(i);
        }
        
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
      }
      
      return new Blob(byteArrays, { type: mimeType });
    } catch (error) {
      console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­ÙˆÙŠÙ„ Base64 Ø¥Ù„Ù‰ Blob:", error);
      // Return a minimal empty audio blob to prevent crashes
      return new Blob([""], { type: mimeType });
    }
  };

  return {
    askAssistant,
    textToSpeech,
    isLoading,
    isAudioLoading
  };
};
